<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Electric Bill Dashboard</title>
  <link rel="stylesheet" href="/css/Record.css">
</head>
<body>

<div class="dashboard-container">

  <aside class="sidebar">
    <div class="logo">

      <h2>‚ö° Electric Bill<br>Calculator</h2>
    </div>

    <nav class="menu">
      <button onclick="window.location.href='Profile.html'">üë§ Profile</button>
      <button onclick="window.location.href='HomePage.html'">üìä Dashboard</button>
      <button onclick="window.location.href='Record.html'">üìÅ Records</button>
    </nav>
  </aside>

  <div class="container">
    <h1>Calculation Results</h1>
    <p class="welcome-text">View all your electricity bill calculations</p>
    
    <div id="result">
      <h3>Result:</h3>
      <table id="myTable" border="1">
        <thead>
          <tr>
            <th>Month</th>
            <th>Power Consumption (kWh)</th>
            <th>Cost Per kWh (‚Ç±)</th>
            <th>Result (‚Ç±)</th>
          </tr>
        </thead>
        <tbody>
          <tr class="empty-row">
            <td colspan="4" class="empty-message">
              No calculations yet. <a href="/html/HomePage.html">Calculate your first bill</a>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/js/supabase-config.js"></script>

  <script>

    async function getCurrentUser() {
      const { data: { user }, error } = await supabaseClient.auth.getUser();
      if (error) {
        console.error("Error getting user:", error);
        return null;
      }
      return user;
    }

    async function signOut() {
      const { error } = await supabaseClient.auth.signOut();
      if (error) {
        console.error("Error signing out:", error);
        return false;
      }
      return true;
    }

    // Load calculations
    async function loadCalculations() {
      const user = await getCurrentUser();
      if (!user || !user.id) {
        console.warn("No user found or user ID missing.");
        return;
      }

      console.log("User ID:", user.id);

      const { data, error } = await supabaseClient
        .from("calculations")
        .select("*")
        .eq("user_id", user.id)
        .order("created_at", { ascending: false });

      if (error) {
        console.error("Supabase error:", error);
        alert("Error loading calculations: " + error.message);
        return;
      }

      console.log("Fetched calculations:", data);

      const table = document.getElementById("myTable");
      const tbody = table.querySelector("tbody");
      tbody.innerHTML = "";

      if (data && data.length > 0) {
        data.forEach(calc => {
          const row = tbody.insertRow();
          row.insertCell(0).textContent = calc.month;
          row.insertCell(1).textContent = parseFloat(calc.power_consumption).toFixed(2);
          row.insertCell(2).textContent = "‚Ç± " + parseFloat(calc.cost_per_kwh).toFixed(2);
          row.insertCell(3).textContent = "‚Ç± " + parseFloat(calc.result).toFixed(2);
        });
      } else {
        const emptyRow = tbody.insertRow();
        emptyRow.className = "empty-row";
        const emptyCell = emptyRow.insertCell(0);
        emptyCell.colSpan = 4;
        emptyCell.className = "empty-message";
        emptyCell.innerHTML = 'No calculations yet. <a href="HomePage.html">Calculate your first bill</a>';
      }
    }

    // On page load
    document.addEventListener("DOMContentLoaded", async () => {
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (session) {
        await loadCalculations();
      } else {
        console.warn("No active session. Redirect to login if needed.");
      }
    });
  </script>

</div>
</body>
</html>
